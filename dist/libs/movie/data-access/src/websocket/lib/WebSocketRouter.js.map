{"version":3,"sources":["../../../../../../../libs/movie/data-access/node_modules/websocket/lib/WebSocketRouter.js"],"sourcesContent":["/************************************************************************\n *  Copyright 2010-2015 Brian McKelvey.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\");\n *  you may not use this file except in compliance with the License.\n *  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n *  Unless required by applicable law or agreed to in writing, software\n *  distributed under the License is distributed on an \"AS IS\" BASIS,\n *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *  See the License for the specific language governing permissions and\n *  limitations under the License.\n ***********************************************************************/\n\nvar extend = require('./utils').extend;\nvar util = require('util');\nvar EventEmitter = require('events').EventEmitter;\nvar WebSocketRouterRequest = require('./WebSocketRouterRequest');\n\nfunction WebSocketRouter(config) {\n    // Superclass Constructor\n    EventEmitter.call(this);\n\n    this.config = {\n        // The WebSocketServer instance to attach to.\n        server: null\n    };\n    if (config) {\n        extend(this.config, config);\n    }\n    this.handlers = [];\n\n    this._requestHandler = this.handleRequest.bind(this);\n    if (this.config.server) {\n        this.attachServer(this.config.server);\n    }\n}\n\nutil.inherits(WebSocketRouter, EventEmitter);\n\nWebSocketRouter.prototype.attachServer = function(server) {\n    if (server) {\n        this.server = server;\n        this.server.on('request', this._requestHandler);\n    }\n    else {\n        throw new Error('You must specify a WebSocketServer instance to attach to.');\n    }\n};\n\nWebSocketRouter.prototype.detachServer = function() {\n    if (this.server) {\n        this.server.removeListener('request', this._requestHandler);\n        this.server = null;\n    }\n    else {\n        throw new Error('Cannot detach from server: not attached.');\n    }\n};\n\nWebSocketRouter.prototype.mount = function(path, protocol, callback) {\n    if (!path) {\n        throw new Error('You must specify a path for this handler.');\n    }\n    if (!protocol) {\n        protocol = '____no_protocol____';\n    }\n    if (!callback) {\n        throw new Error('You must specify a callback for this handler.');\n    }\n\n    path = this.pathToRegExp(path);\n    if (!(path instanceof RegExp)) {\n        throw new Error('Path must be specified as either a string or a RegExp.');\n    }\n    var pathString = path.toString();\n\n    // normalize protocol to lower-case\n    protocol = protocol.toLocaleLowerCase();\n\n    if (this.findHandlerIndex(pathString, protocol) !== -1) {\n        throw new Error('You may only mount one handler per path/protocol combination.');\n    }\n\n    this.handlers.push({\n        'path': path,\n        'pathString': pathString,\n        'protocol': protocol,\n        'callback': callback\n    });\n};\nWebSocketRouter.prototype.unmount = function(path, protocol) {\n    var index = this.findHandlerIndex(this.pathToRegExp(path).toString(), protocol);\n    if (index !== -1) {\n        this.handlers.splice(index, 1);\n    }\n    else {\n        throw new Error('Unable to find a route matching the specified path and protocol.');\n    }\n};\n\nWebSocketRouter.prototype.findHandlerIndex = function(pathString, protocol) {\n    protocol = protocol.toLocaleLowerCase();\n    for (var i=0, len=this.handlers.length; i < len; i++) {\n        var handler = this.handlers[i];\n        if (handler.pathString === pathString && handler.protocol === protocol) {\n            return i;\n        }\n    }\n    return -1;\n};\n\nWebSocketRouter.prototype.pathToRegExp = function(path) {\n    if (typeof(path) === 'string') {\n        if (path === '*') {\n            path = /^.*$/;\n        }\n        else {\n            path = path.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, '\\\\$&');\n            path = new RegExp('^' + path + '$');\n        }\n    }\n    return path;\n};\n\nWebSocketRouter.prototype.handleRequest = function(request) {\n    var requestedProtocols = request.requestedProtocols;\n    if (requestedProtocols.length === 0) {\n        requestedProtocols = ['____no_protocol____'];\n    }\n\n    // Find a handler with the first requested protocol first\n    for (var i=0; i < requestedProtocols.length; i++) {\n        var requestedProtocol = requestedProtocols[i].toLocaleLowerCase();\n\n        // find the first handler that can process this request\n        for (var j=0, len=this.handlers.length; j < len; j++) {\n            var handler = this.handlers[j];\n            if (handler.path.test(request.resourceURL.pathname)) {\n                if (requestedProtocol === handler.protocol ||\n                    handler.protocol === '*')\n                {\n                    var routerRequest = new WebSocketRouterRequest(request, requestedProtocol);\n                    handler.callback(routerRequest);\n                    return;\n                }\n            }\n        }\n    }\n\n    // If we get here we were unable to find a suitable handler.\n    request.reject(404, 'No handler is available for the given request.');\n};\n\nmodule.exports = WebSocketRouter;\n"],"names":["extend","require","util","EventEmitter","WebSocketRouterRequest","WebSocketRouter","config","call","server","handlers","_requestHandler","handleRequest","bind","attachServer","inherits","prototype","on","Error","detachServer","removeListener","mount","path","protocol","callback","pathToRegExp","RegExp","pathString","toString","toLocaleLowerCase","findHandlerIndex","push","unmount","index","splice","i","len","length","handler","replace","request","requestedProtocols","requestedProtocol","j","test","resourceURL","pathname","routerRequest","reject","module","exports"],"mappings":"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"}