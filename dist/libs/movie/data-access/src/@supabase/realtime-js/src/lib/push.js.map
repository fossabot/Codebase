{"version":3,"sources":["../../../../../../../../../libs/movie/data-access/node_modules/@supabase/realtime-js/src/lib/push.ts"],"sourcesContent":["import { DEFAULT_TIMEOUT } from '../lib/constants'\nimport RealtimeSubscription from '../RealtimeSubscription'\n\nexport default class Push {\n  sent: boolean = false\n  timeoutTimer: number | undefined = undefined\n  ref: string = ''\n  receivedResp: {\n    status: string\n    response: Function\n  } | null = null\n  recHooks: {\n    status: string\n    callback: Function\n  }[] = []\n  refEvent: string | null = null\n\n  /**\n   * Initializes the Push\n   *\n   * @param channel The Channel\n   * @param event The event, for example `\"phx_join\"`\n   * @param payload The payload, for example `{user_id: 123}`\n   * @param timeout The push timeout in milliseconds\n   */\n  constructor(\n    public channel: RealtimeSubscription,\n    public event: string,\n    public payload: { [key: string]: unknown } = {},\n    public timeout: number = DEFAULT_TIMEOUT\n  ) {}\n\n  resend(timeout: number) {\n    this.timeout = timeout\n    this._cancelRefEvent()\n    this.ref = ''\n    this.refEvent = null\n    this.receivedResp = null\n    this.sent = false\n    this.send()\n  }\n\n  send() {\n    if (this._hasReceived('timeout')) {\n      return\n    }\n    this.startTimeout()\n    this.sent = true\n    this.channel.socket.push({\n      topic: this.channel.topic,\n      event: this.event,\n      payload: this.payload,\n      ref: this.ref,\n    })\n  }\n\n  updatePayload(payload: { [key: string]: unknown }): void {\n    this.payload = { ...this.payload, ...payload }\n  }\n\n  receive(status: string, callback: Function) {\n    if (this._hasReceived(status)) {\n      callback(this.receivedResp?.response)\n    }\n\n    this.recHooks.push({ status, callback })\n    return this\n  }\n\n  startTimeout() {\n    if (this.timeoutTimer) {\n      return\n    }\n    this.ref = this.channel.socket.makeRef()\n    this.refEvent = this.channel.replyEventName(this.ref)\n\n    this.channel.on(this.refEvent, (payload: any) => {\n      this._cancelRefEvent()\n      this._cancelTimeout()\n      this.receivedResp = payload\n      this._matchReceive(payload)\n    })\n\n    this.timeoutTimer = <any>setTimeout(() => {\n      this.trigger('timeout', {})\n    }, this.timeout)\n  }\n\n  trigger(status: string, response: any) {\n    if (this.refEvent) this.channel.trigger(this.refEvent, { status, response })\n  }\n\n  destroy() {\n    this._cancelRefEvent()\n    this._cancelTimeout()\n  }\n\n  private _cancelRefEvent() {\n    if (!this.refEvent) {\n      return\n    }\n    this.channel.off(this.refEvent)\n  }\n\n  private _cancelTimeout() {\n    clearTimeout(this.timeoutTimer)\n    this.timeoutTimer = undefined\n  }\n\n  private _matchReceive({\n    status,\n    response,\n  }: {\n    status: string\n    response: Function\n  }) {\n    this.recHooks\n      .filter((h) => h.status === status)\n      .forEach((h) => h.callback(response))\n  }\n\n  private _hasReceived(status: string) {\n    return this.receivedResp && this.receivedResp.status === status\n  }\n}\n"],"names":["Push","resend","timeout","_cancelRefEvent","ref","refEvent","receivedResp","sent","send","_hasReceived","startTimeout","channel","socket","push","topic","event","payload","updatePayload","receive","status","callback","response","recHooks","timeoutTimer","makeRef","replyEventName","on","_cancelTimeout","_matchReceive","setTimeout","trigger","destroy","off","clearTimeout","undefined","filter","h","forEach","DEFAULT_TIMEOUT"],"mappings":"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"}