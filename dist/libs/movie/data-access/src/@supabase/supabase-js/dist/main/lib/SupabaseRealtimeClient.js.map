{"version":3,"sources":["../../../../../../../../../../libs/movie/data-access/node_modules/@supabase/supabase-js/dist/main/lib/SupabaseRealtimeClient.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.SupabaseRealtimeClient = void 0;\nconst realtime_js_1 = require(\"@supabase/realtime-js\");\nclass SupabaseRealtimeClient {\n    constructor(socket, headers, schema, tableName) {\n        const chanParams = {};\n        const topic = tableName === '*' ? `realtime:${schema}` : `realtime:${schema}:${tableName}`;\n        const userToken = headers['Authorization'].split(' ')[1];\n        if (userToken) {\n            chanParams['user_token'] = userToken;\n        }\n        this.subscription = socket.channel(topic, chanParams);\n    }\n    getPayloadRecords(payload) {\n        const records = {\n            new: {},\n            old: {},\n        };\n        if (payload.type === 'INSERT' || payload.type === 'UPDATE') {\n            records.new = realtime_js_1.Transformers.convertChangeData(payload.columns, payload.record);\n        }\n        if (payload.type === 'UPDATE' || payload.type === 'DELETE') {\n            records.old = realtime_js_1.Transformers.convertChangeData(payload.columns, payload.old_record);\n        }\n        return records;\n    }\n    /**\n     * The event you want to listen to.\n     *\n     * @param event The event\n     * @param callback A callback function that is called whenever the event occurs.\n     */\n    on(event, callback) {\n        this.subscription.on(event, (payload) => {\n            let enrichedPayload = {\n                schema: payload.schema,\n                table: payload.table,\n                commit_timestamp: payload.commit_timestamp,\n                eventType: payload.type,\n                new: {},\n                old: {},\n                errors: payload.errors,\n            };\n            enrichedPayload = Object.assign(Object.assign({}, enrichedPayload), this.getPayloadRecords(payload));\n            callback(enrichedPayload);\n        });\n        return this;\n    }\n    /**\n     * Enables the subscription.\n     */\n    subscribe(callback = () => { }) {\n        this.subscription.onError((e) => callback('SUBSCRIPTION_ERROR', e));\n        this.subscription.onClose(() => callback('CLOSED'));\n        this.subscription\n            .subscribe()\n            .receive('ok', () => callback('SUBSCRIBED'))\n            .receive('error', (e) => callback('SUBSCRIPTION_ERROR', e))\n            .receive('timeout', () => callback('RETRYING_AFTER_TIMEOUT'));\n        return this.subscription;\n    }\n}\nexports.SupabaseRealtimeClient = SupabaseRealtimeClient;\n//# sourceMappingURL=SupabaseRealtimeClient.js.map"],"names":["Object","defineProperty","exports","value","SupabaseRealtimeClient","realtime_js_1","require","getPayloadRecords","payload","records","new","old","type","Transformers","convertChangeData","columns","record","old_record","on","event","callback","subscription","enrichedPayload","schema","table","commit_timestamp","eventType","errors","assign","subscribe","onError","e","onClose","receive","socket","headers","tableName","chanParams","topic","userToken","split","channel"],"mappings":"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"}