{"version":3,"sources":["../../../../../../../../../libs/movie/data-access/node_modules/@supabase/supabase-js/src/lib/SupabaseRealtimeClient.ts"],"sourcesContent":["import { RealtimeSubscription, RealtimeClient, Transformers } from '@supabase/realtime-js'\nimport { GenericObject, SupabaseEventTypes, SupabaseRealtimePayload } from './types'\n\nexport class SupabaseRealtimeClient {\n  subscription: RealtimeSubscription\n\n  constructor(socket: RealtimeClient, headers: GenericObject, schema: string, tableName: string) {\n    const chanParams: GenericObject = {}\n    const topic = tableName === '*' ? `realtime:${schema}` : `realtime:${schema}:${tableName}`\n    const userToken = headers['Authorization'].split(' ')[1]\n\n    if (userToken) {\n      chanParams['user_token'] = userToken\n    }\n\n    this.subscription = socket.channel(topic, chanParams)\n  }\n\n  private getPayloadRecords(payload: any) {\n    const records = {\n      new: {},\n      old: {},\n    }\n\n    if (payload.type === 'INSERT' || payload.type === 'UPDATE') {\n      records.new = Transformers.convertChangeData(payload.columns, payload.record)\n    }\n\n    if (payload.type === 'UPDATE' || payload.type === 'DELETE') {\n      records.old = Transformers.convertChangeData(payload.columns, payload.old_record)\n    }\n\n    return records\n  }\n\n  /**\n   * The event you want to listen to.\n   *\n   * @param event The event\n   * @param callback A callback function that is called whenever the event occurs.\n   */\n  on(event: SupabaseEventTypes, callback: (payload: SupabaseRealtimePayload<any>) => void) {\n    this.subscription.on(event, (payload: any) => {\n      let enrichedPayload: SupabaseRealtimePayload<any> = {\n        schema: payload.schema,\n        table: payload.table,\n        commit_timestamp: payload.commit_timestamp,\n        eventType: payload.type,\n        new: {},\n        old: {},\n        errors: payload.errors,\n      }\n\n      enrichedPayload = { ...enrichedPayload, ...this.getPayloadRecords(payload) }\n\n      callback(enrichedPayload)\n    })\n    return this\n  }\n\n  /**\n   * Enables the subscription.\n   */\n  subscribe(callback: Function = () => {}) {\n    this.subscription.onError((e: Error) => callback('SUBSCRIPTION_ERROR', e))\n    this.subscription.onClose(() => callback('CLOSED'))\n    this.subscription\n      .subscribe()\n      .receive('ok', () => callback('SUBSCRIBED'))\n      .receive('error', (e: Error) => callback('SUBSCRIPTION_ERROR', e))\n      .receive('timeout', () => callback('RETRYING_AFTER_TIMEOUT'))\n    return this.subscription\n  }\n}\n"],"names":["SupabaseRealtimeClient","getPayloadRecords","payload","records","new","old","type","Transformers","convertChangeData","columns","record","old_record","on","event","callback","subscription","enrichedPayload","schema","table","commit_timestamp","eventType","errors","subscribe","onError","e","onClose","receive","socket","headers","tableName","chanParams","topic","userToken","split","channel"],"mappings":"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"}