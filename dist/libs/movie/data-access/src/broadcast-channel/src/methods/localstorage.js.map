{"version":3,"sources":["../../../../../../../../libs/movie/data-access/node_modules/broadcast-channel/src/methods/localstorage.js"],"sourcesContent":["/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\n\nimport { ObliviousSet } from 'oblivious-set';\n\nimport {\n    fillOptionsWithDefaults\n} from '../options';\n\nimport {\n    sleep,\n    randomToken,\n    microSeconds as micro,\n    isNode\n} from '../util';\n\nexport const microSeconds = micro;\n\nconst KEY_PREFIX = 'pubkey.broadcastChannel-';\nexport const type = 'localstorage';\n\n/**\n * copied from crosstab\n * @link https://github.com/tejacques/crosstab/blob/master/src/crosstab.js#L32\n */\nexport function getLocalStorage() {\n    let localStorage;\n    if (typeof window === 'undefined') return null;\n    try {\n        localStorage = window.localStorage;\n        localStorage = window['ie8-eventlistener/storage'] || window.localStorage;\n    } catch (e) {\n        // New versions of Firefox throw a Security exception\n        // if cookies are disabled. See\n        // https://bugzilla.mozilla.org/show_bug.cgi?id=1028153\n    }\n    return localStorage;\n}\n\nexport function storageKey(channelName) {\n    return KEY_PREFIX + channelName;\n}\n\n\n/**\n* writes the new message to the storage\n* and fires the storage-event so other readers can find it\n*/\nexport function postMessage(channelState, messageJson) {\n    return new Promise(res => {\n        sleep().then(() => {\n            const key = storageKey(channelState.channelName);\n            const writeObj = {\n                token: randomToken(),\n                time: new Date().getTime(),\n                data: messageJson,\n                uuid: channelState.uuid\n            };\n            const value = JSON.stringify(writeObj);\n            getLocalStorage().setItem(key, value);\n\n            /**\n             * StorageEvent does not fire the 'storage' event\n             * in the window that changes the state of the local storage.\n             * So we fire it manually\n             */\n            const ev = document.createEvent('Event');\n            ev.initEvent('storage', true, true);\n            ev.key = key;\n            ev.newValue = value;\n            window.dispatchEvent(ev);\n\n            res();\n        });\n    });\n}\n\nexport function addStorageEventListener(channelName, fn) {\n    const key = storageKey(channelName);\n    const listener = ev => {\n        if (ev.key === key) {\n            fn(JSON.parse(ev.newValue));\n        }\n    };\n    window.addEventListener('storage', listener);\n    return listener;\n}\nexport function removeStorageEventListener(listener) {\n    window.removeEventListener('storage', listener);\n}\n\nexport function create(channelName, options) {\n    options = fillOptionsWithDefaults(options);\n    if (!canBeUsed()) {\n        throw new Error('BroadcastChannel: localstorage cannot be used');\n    }\n\n    const uuid = randomToken();\n\n    /**\n     * eMIs\n     * contains all messages that have been emitted before\n     * @type {ObliviousSet}\n     */\n    const eMIs = new ObliviousSet(options.localstorage.removeTimeout);\n\n    const state = {\n        channelName,\n        uuid,\n        eMIs // emittedMessagesIds\n    };\n\n\n    state.listener = addStorageEventListener(\n        channelName,\n        (msgObj) => {\n            if (!state.messagesCallback) return; // no listener\n            if (msgObj.uuid === uuid) return; // own message\n            if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n            if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n            eMIs.add(msgObj.token);\n            state.messagesCallback(msgObj.data);\n        }\n    );\n\n\n    return state;\n}\n\nexport function close(channelState) {\n    removeStorageEventListener(channelState.listener);\n}\n\nexport function onMessage(channelState, fn, time) {\n    channelState.messagesCallbackTime = time;\n    channelState.messagesCallback = fn;\n}\n\nexport function canBeUsed() {\n    if (isNode) return false;\n    const ls = getLocalStorage();\n\n    if (!ls) return false;\n\n    try {\n        const key = '__broadcastchannel_check';\n        ls.setItem(key, 'works');\n        ls.removeItem(key);\n    } catch (e) {\n        // Safari 10 in private mode will not allow write access to local\n        // storage and fail with a QuotaExceededError. See\n        // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API#Private_Browsing_Incognito_modes\n        return false;\n    }\n\n    return true;\n}\n\n\nexport function averageResponseTime() {\n    const defaultTime = 120;\n    const userAgent = navigator.userAgent.toLowerCase();\n    if (userAgent.includes('safari') && !userAgent.includes('chrome')) {\n        // safari is much slower so this time is higher\n        return defaultTime * 2;\n    }\n    return defaultTime;\n}\n\nexport default {\n    create,\n    close,\n    onMessage,\n    postMessage,\n    canBeUsed,\n    type,\n    averageResponseTime,\n    microSeconds\n};\n"],"names":["getLocalStorage","storageKey","postMessage","addStorageEventListener","removeStorageEventListener","create","close","onMessage","canBeUsed","averageResponseTime","microSeconds","micro","KEY_PREFIX","type","localStorage","window","e","channelName","channelState","messageJson","Promise","res","sleep","then","key","writeObj","token","randomToken","time","Date","getTime","data","uuid","value","JSON","stringify","setItem","ev","document","createEvent","initEvent","newValue","dispatchEvent","fn","listener","parse","addEventListener","removeEventListener","options","fillOptionsWithDefaults","Error","eMIs","ObliviousSet","localstorage","removeTimeout","state","msgObj","messagesCallback","has","messagesCallbackTime","add","isNode","ls","removeItem","defaultTime","userAgent","navigator","toLowerCase","includes"],"mappings":"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"}