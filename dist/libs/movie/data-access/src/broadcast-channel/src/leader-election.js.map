{"version":3,"sources":["../../../../../../../libs/movie/data-access/node_modules/broadcast-channel/src/leader-election.js"],"sourcesContent":["import {\n    sleep,\n    randomToken\n} from './util.js';\n\nimport unload from 'unload';\n\nconst LeaderElection = function (channel, options) {\n    this._channel = channel;\n    this._options = options;\n\n    this.isLeader = false;\n    this.isDead = false;\n    this.token = randomToken();\n\n    this._isApl = false; // _isApplying\n    this._reApply = false;\n\n    // things to clean up\n    this._unl = []; // _unloads\n    this._lstns = []; // _listeners\n    this._invs = []; // _intervals\n    this._dpL = () => { }; // onduplicate listener\n    this._dpLC = false; // true when onduplicate called\n};\n\nLeaderElection.prototype = {\n    applyOnce() {\n        if (this.isLeader) return Promise.resolve(false);\n        if (this.isDead) return Promise.resolve(false);\n\n        // do nothing if already running\n        if (this._isApl) {\n            this._reApply = true;\n            return Promise.resolve(false);\n        }\n        this._isApl = true;\n\n        let stopCriteria = false;\n        const recieved = [];\n\n        const handleMessage = (msg) => {\n            if (msg.context === 'leader' && msg.token != this.token) {\n                recieved.push(msg);\n\n                if (msg.action === 'apply') {\n                    // other is applying\n                    if (msg.token > this.token) {\n                        // other has higher token, stop applying\n                        stopCriteria = true;\n                    }\n                }\n\n                if (msg.action === 'tell') {\n                    // other is already leader\n                    stopCriteria = true;\n                }\n            }\n        };\n        this._channel.addEventListener('internal', handleMessage);\n\n\n\n        const ret = _sendMessage(this, 'apply') // send out that this one is applying\n            .then(() => sleep(this._options.responseTime)) // let others time to respond\n            .then(() => {\n                if (stopCriteria) return Promise.reject(new Error());\n                else return _sendMessage(this, 'apply');\n            })\n            .then(() => sleep(this._options.responseTime)) // let others time to respond\n            .then(() => {\n                if (stopCriteria) return Promise.reject(new Error());\n                else return _sendMessage(this);\n            })\n            .then(() => beLeader(this)) // no one disagreed -> this one is now leader\n            .then(() => true)\n            .catch(() => false) // apply not successfull\n            .then(success => {\n                this._channel.removeEventListener('internal', handleMessage);\n                this._isApl = false;\n                if (!success && this._reApply) {\n                    this._reApply = false;\n                    return this.applyOnce();\n                } else return success;\n            });\n        return ret;\n    },\n\n    awaitLeadership() {\n        if (\n            /* _awaitLeadershipPromise */\n            !this._aLP\n        ) {\n            this._aLP = _awaitLeadershipOnce(this);\n        }\n        return this._aLP;\n    },\n\n    set onduplicate(fn) {\n        this._dpL = fn;\n    },\n\n    die() {\n        if (this.isDead) return;\n        this.isDead = true;\n\n        this._lstns.forEach(listener => this._channel.removeEventListener('internal', listener));\n        this._invs.forEach(interval => clearInterval(interval));\n        this._unl.forEach(uFn => {\n            uFn.remove();\n        });\n        return _sendMessage(this, 'death');\n    }\n};\n\nfunction _awaitLeadershipOnce(leaderElector) {\n    if (leaderElector.isLeader) return Promise.resolve();\n\n    return new Promise((res) => {\n        let resolved = false;\n\n        function finish() {\n            if (resolved) {\n                return;\n            }\n            resolved = true;\n            clearInterval(interval);\n            leaderElector._channel.removeEventListener('internal', whenDeathListener);\n            res(true);\n        }\n\n        // try once now\n        leaderElector.applyOnce().then(() => {\n            if (leaderElector.isLeader) {\n                finish();\n            }\n        });\n\n        // try on fallbackInterval\n        const interval = setInterval(() => {\n            leaderElector.applyOnce().then(() => {\n                if (leaderElector.isLeader) {\n                    finish();\n                }\n            });\n        }, leaderElector._options.fallbackInterval);\n        leaderElector._invs.push(interval);\n\n        // try when other leader dies\n        const whenDeathListener = msg => {\n            if (msg.context === 'leader' && msg.action === 'death') {\n                leaderElector.applyOnce().then(() => {\n                    if (leaderElector.isLeader) finish();\n                });\n            }\n        };\n        leaderElector._channel.addEventListener('internal', whenDeathListener);\n        leaderElector._lstns.push(whenDeathListener);\n    });\n}\n\n/**\n * sends and internal message over the broadcast-channel\n */\nfunction _sendMessage(leaderElector, action) {\n    const msgJson = {\n        context: 'leader',\n        action,\n        token: leaderElector.token\n    };\n    return leaderElector._channel.postInternal(msgJson);\n}\n\nexport function beLeader(leaderElector) {\n    leaderElector.isLeader = true;\n    const unloadFn = unload.add(() => leaderElector.die());\n    leaderElector._unl.push(unloadFn);\n\n    const isLeaderListener = msg => {\n        if (msg.context === 'leader' && msg.action === 'apply') {\n            _sendMessage(leaderElector, 'tell');\n        }\n\n        if (msg.context === 'leader' && msg.action === 'tell' && !leaderElector._dpLC) {\n            /**\n             * another instance is also leader!\n             * This can happen on rare events\n             * like when the CPU is at 100% for long time\n             * or the tabs are open very long and the browser throttles them.\n             * @link https://github.com/pubkey/broadcast-channel/issues/414\n             * @link https://github.com/pubkey/broadcast-channel/issues/385\n             */\n            leaderElector._dpLC = true;\n            leaderElector._dpL(); // message the lib user so the app can handle the problem\n            _sendMessage(leaderElector, 'tell'); // ensure other leader also knows the problem\n        }\n    };\n    leaderElector._channel.addEventListener('internal', isLeaderListener);\n    leaderElector._lstns.push(isLeaderListener);\n    return _sendMessage(leaderElector, 'tell');\n}\n\n\nfunction fillOptionsWithDefaults(options, channel) {\n    if (!options) options = {};\n    options = JSON.parse(JSON.stringify(options));\n\n    if (!options.fallbackInterval) {\n        options.fallbackInterval = 3000;\n    }\n\n    if (!options.responseTime) {\n        options.responseTime = channel.method.averageResponseTime(channel.options);\n    }\n\n    return options;\n}\n\nexport function createLeaderElection(channel, options) {\n    if (channel._leaderElector) {\n        throw new Error('BroadcastChannel already has a leader-elector');\n    }\n\n    options = fillOptionsWithDefaults(options, channel);\n    const elector = new LeaderElection(channel, options);\n    channel._befC.push(() => elector.die());\n\n    channel._leaderElector = elector;\n    return elector;\n}\n"],"names":["beLeader","createLeaderElection","LeaderElection","channel","options","_channel","_options","isLeader","isDead","token","randomToken","_isApl","_reApply","_unl","_lstns","_invs","_dpL","_dpLC","prototype","applyOnce","Promise","resolve","stopCriteria","recieved","handleMessage","msg","context","push","action","addEventListener","ret","_sendMessage","then","sleep","responseTime","reject","Error","catch","success","removeEventListener","awaitLeadership","_aLP","_awaitLeadershipOnce","onduplicate","fn","die","forEach","listener","interval","clearInterval","uFn","remove","leaderElector","res","resolved","finish","whenDeathListener","setInterval","fallbackInterval","msgJson","postInternal","unloadFn","unload","add","isLeaderListener","fillOptionsWithDefaults","JSON","parse","stringify","method","averageResponseTime","_leaderElector","elector","_befC"],"mappings":"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"}