{"version":3,"sources":["../../../../../../../../../libs/movie/data-access/node_modules/broadcast-channel/dist/es/methods/localstorage.js"],"sourcesContent":["/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\nimport { ObliviousSet } from 'oblivious-set';\nimport { fillOptionsWithDefaults } from '../options';\nimport { sleep, randomToken, microSeconds as micro, isNode } from '../util';\nexport var microSeconds = micro;\nvar KEY_PREFIX = 'pubkey.broadcastChannel-';\nexport var type = 'localstorage';\n/**\n * copied from crosstab\n * @link https://github.com/tejacques/crosstab/blob/master/src/crosstab.js#L32\n */\n\nexport function getLocalStorage() {\n  var localStorage;\n  if (typeof window === 'undefined') return null;\n\n  try {\n    localStorage = window.localStorage;\n    localStorage = window['ie8-eventlistener/storage'] || window.localStorage;\n  } catch (e) {// New versions of Firefox throw a Security exception\n    // if cookies are disabled. See\n    // https://bugzilla.mozilla.org/show_bug.cgi?id=1028153\n  }\n\n  return localStorage;\n}\nexport function storageKey(channelName) {\n  return KEY_PREFIX + channelName;\n}\n/**\n* writes the new message to the storage\n* and fires the storage-event so other readers can find it\n*/\n\nexport function postMessage(channelState, messageJson) {\n  return new Promise(function (res) {\n    sleep().then(function () {\n      var key = storageKey(channelState.channelName);\n      var writeObj = {\n        token: randomToken(),\n        time: new Date().getTime(),\n        data: messageJson,\n        uuid: channelState.uuid\n      };\n      var value = JSON.stringify(writeObj);\n      getLocalStorage().setItem(key, value);\n      /**\n       * StorageEvent does not fire the 'storage' event\n       * in the window that changes the state of the local storage.\n       * So we fire it manually\n       */\n\n      var ev = document.createEvent('Event');\n      ev.initEvent('storage', true, true);\n      ev.key = key;\n      ev.newValue = value;\n      window.dispatchEvent(ev);\n      res();\n    });\n  });\n}\nexport function addStorageEventListener(channelName, fn) {\n  var key = storageKey(channelName);\n\n  var listener = function listener(ev) {\n    if (ev.key === key) {\n      fn(JSON.parse(ev.newValue));\n    }\n  };\n\n  window.addEventListener('storage', listener);\n  return listener;\n}\nexport function removeStorageEventListener(listener) {\n  window.removeEventListener('storage', listener);\n}\nexport function create(channelName, options) {\n  options = fillOptionsWithDefaults(options);\n\n  if (!canBeUsed()) {\n    throw new Error('BroadcastChannel: localstorage cannot be used');\n  }\n\n  var uuid = randomToken();\n  /**\n   * eMIs\n   * contains all messages that have been emitted before\n   * @type {ObliviousSet}\n   */\n\n  var eMIs = new ObliviousSet(options.localstorage.removeTimeout);\n  var state = {\n    channelName: channelName,\n    uuid: uuid,\n    eMIs: eMIs // emittedMessagesIds\n\n  };\n  state.listener = addStorageEventListener(channelName, function (msgObj) {\n    if (!state.messagesCallback) return; // no listener\n\n    if (msgObj.uuid === uuid) return; // own message\n\n    if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n\n    if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n    eMIs.add(msgObj.token);\n    state.messagesCallback(msgObj.data);\n  });\n  return state;\n}\nexport function close(channelState) {\n  removeStorageEventListener(channelState.listener);\n}\nexport function onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n}\nexport function canBeUsed() {\n  if (isNode) return false;\n  var ls = getLocalStorage();\n  if (!ls) return false;\n\n  try {\n    var key = '__broadcastchannel_check';\n    ls.setItem(key, 'works');\n    ls.removeItem(key);\n  } catch (e) {\n    // Safari 10 in private mode will not allow write access to local\n    // storage and fail with a QuotaExceededError. See\n    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API#Private_Browsing_Incognito_modes\n    return false;\n  }\n\n  return true;\n}\nexport function averageResponseTime() {\n  var defaultTime = 120;\n  var userAgent = navigator.userAgent.toLowerCase();\n\n  if (userAgent.includes('safari') && !userAgent.includes('chrome')) {\n    // safari is much slower so this time is higher\n    return defaultTime * 2;\n  }\n\n  return defaultTime;\n}\nexport default {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};"],"names":["getLocalStorage","storageKey","postMessage","addStorageEventListener","removeStorageEventListener","create","close","onMessage","canBeUsed","averageResponseTime","microSeconds","micro","KEY_PREFIX","type","localStorage","window","e","channelName","channelState","messageJson","Promise","res","sleep","then","key","writeObj","token","randomToken","time","Date","getTime","data","uuid","value","JSON","stringify","setItem","ev","document","createEvent","initEvent","newValue","dispatchEvent","fn","listener","parse","addEventListener","removeEventListener","options","fillOptionsWithDefaults","Error","eMIs","ObliviousSet","localstorage","removeTimeout","state","msgObj","messagesCallback","has","messagesCallbackTime","add","isNode","ls","removeItem","defaultTime","userAgent","navigator","toLowerCase","includes"],"mappings":"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"}