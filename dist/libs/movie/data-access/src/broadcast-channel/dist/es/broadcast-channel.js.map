{"version":3,"sources":["../../../../../../../../libs/movie/data-access/node_modules/broadcast-channel/dist/es/broadcast-channel.js"],"sourcesContent":["import { isPromise } from './util.js';\nimport { chooseMethod } from './method-chooser.js';\nimport { fillOptionsWithDefaults } from './options.js';\nexport var BroadcastChannel = function BroadcastChannel(name, options) {\n  this.name = name;\n\n  if (ENFORCED_OPTIONS) {\n    options = ENFORCED_OPTIONS;\n  }\n\n  this.options = fillOptionsWithDefaults(options);\n  this.method = chooseMethod(this.options); // isListening\n\n  this._iL = false;\n  /**\n   * _onMessageListener\n   * setting onmessage twice,\n   * will overwrite the first listener\n   */\n\n  this._onML = null;\n  /**\n   * _addEventListeners\n   */\n\n  this._addEL = {\n    message: [],\n    internal: []\n  };\n  /**\n   * Unsend message promises\n   * where the sending is still in progress\n   * @type {Set<Promise>}\n   */\n\n  this._uMP = new Set();\n  /**\n   * _beforeClose\n   * array of promises that will be awaited\n   * before the channel is closed\n   */\n\n  this._befC = [];\n  /**\n   * _preparePromise\n   */\n\n  this._prepP = null;\n\n  _prepareChannel(this);\n}; // STATICS\n\n/**\n * used to identify if someone overwrites\n * window.BroadcastChannel with this\n * See methods/native.js\n */\n\nBroadcastChannel._pubkey = true;\n/**\n * clears the tmp-folder if is node\n * @return {Promise<boolean>} true if has run, false if not node\n */\n\nexport function clearNodeFolder(options) {\n  options = fillOptionsWithDefaults(options);\n  var method = chooseMethod(options);\n\n  if (method.type === 'node') {\n    return method.clearNodeFolder().then(function () {\n      return true;\n    });\n  } else {\n    return Promise.resolve(false);\n  }\n}\n/**\n * if set, this method is enforced,\n * no mather what the options are\n */\n\nvar ENFORCED_OPTIONS;\nexport function enforceOptions(options) {\n  ENFORCED_OPTIONS = options;\n} // PROTOTYPE\n\nBroadcastChannel.prototype = {\n  postMessage: function postMessage(msg) {\n    if (this.closed) {\n      throw new Error('BroadcastChannel.postMessage(): ' + 'Cannot post message after channel has closed');\n    }\n\n    return _post(this, 'message', msg);\n  },\n  postInternal: function postInternal(msg) {\n    return _post(this, 'internal', msg);\n  },\n\n  set onmessage(fn) {\n    var time = this.method.microSeconds();\n    var listenObj = {\n      time: time,\n      fn: fn\n    };\n\n    _removeListenerObject(this, 'message', this._onML);\n\n    if (fn && typeof fn === 'function') {\n      this._onML = listenObj;\n\n      _addListenerObject(this, 'message', listenObj);\n    } else {\n      this._onML = null;\n    }\n  },\n\n  addEventListener: function addEventListener(type, fn) {\n    var time = this.method.microSeconds();\n    var listenObj = {\n      time: time,\n      fn: fn\n    };\n\n    _addListenerObject(this, type, listenObj);\n  },\n  removeEventListener: function removeEventListener(type, fn) {\n    var obj = this._addEL[type].find(function (obj) {\n      return obj.fn === fn;\n    });\n\n    _removeListenerObject(this, type, obj);\n  },\n  close: function close() {\n    var _this = this;\n\n    if (this.closed) {\n      return;\n    }\n\n    this.closed = true;\n    var awaitPrepare = this._prepP ? this._prepP : Promise.resolve();\n    this._onML = null;\n    this._addEL.message = [];\n    return awaitPrepare // wait until all current sending are processed\n    .then(function () {\n      return Promise.all(Array.from(_this._uMP));\n    }) // run before-close hooks\n    .then(function () {\n      return Promise.all(_this._befC.map(function (fn) {\n        return fn();\n      }));\n    }) // close the channel\n    .then(function () {\n      return _this.method.close(_this._state);\n    });\n  },\n\n  get type() {\n    return this.method.type;\n  },\n\n  get isClosed() {\n    return this.closed;\n  }\n\n};\n/**\n * Post a message over the channel\n * @returns {Promise} that resolved when the message sending is done\n */\n\nfunction _post(broadcastChannel, type, msg) {\n  var time = broadcastChannel.method.microSeconds();\n  var msgObj = {\n    time: time,\n    type: type,\n    data: msg\n  };\n  var awaitPrepare = broadcastChannel._prepP ? broadcastChannel._prepP : Promise.resolve();\n  return awaitPrepare.then(function () {\n    var sendPromise = broadcastChannel.method.postMessage(broadcastChannel._state, msgObj); // add/remove to unsend messages list\n\n    broadcastChannel._uMP.add(sendPromise);\n\n    sendPromise[\"catch\"]().then(function () {\n      return broadcastChannel._uMP[\"delete\"](sendPromise);\n    });\n    return sendPromise;\n  });\n}\n\nfunction _prepareChannel(channel) {\n  var maybePromise = channel.method.create(channel.name, channel.options);\n\n  if (isPromise(maybePromise)) {\n    channel._prepP = maybePromise;\n    maybePromise.then(function (s) {\n      // used in tests to simulate slow runtime\n\n      /*if (channel.options.prepareDelay) {\n           await new Promise(res => setTimeout(res, this.options.prepareDelay));\n      }*/\n      channel._state = s;\n    });\n  } else {\n    channel._state = maybePromise;\n  }\n}\n\nfunction _hasMessageListeners(channel) {\n  if (channel._addEL.message.length > 0) return true;\n  if (channel._addEL.internal.length > 0) return true;\n  return false;\n}\n\nfunction _addListenerObject(channel, type, obj) {\n  channel._addEL[type].push(obj);\n\n  _startListening(channel);\n}\n\nfunction _removeListenerObject(channel, type, obj) {\n  channel._addEL[type] = channel._addEL[type].filter(function (o) {\n    return o !== obj;\n  });\n\n  _stopListening(channel);\n}\n\nfunction _startListening(channel) {\n  if (!channel._iL && _hasMessageListeners(channel)) {\n    // someone is listening, start subscribing\n    var listenerFn = function listenerFn(msgObj) {\n      channel._addEL[msgObj.type].forEach(function (obj) {\n        if (msgObj.time >= obj.time) {\n          obj.fn(msgObj.data);\n        }\n      });\n    };\n\n    var time = channel.method.microSeconds();\n\n    if (channel._prepP) {\n      channel._prepP.then(function () {\n        channel._iL = true;\n        channel.method.onMessage(channel._state, listenerFn, time);\n      });\n    } else {\n      channel._iL = true;\n      channel.method.onMessage(channel._state, listenerFn, time);\n    }\n  }\n}\n\nfunction _stopListening(channel) {\n  if (channel._iL && !_hasMessageListeners(channel)) {\n    // noone is listening, stop subscribing\n    channel._iL = false;\n    var time = channel.method.microSeconds();\n    channel.method.onMessage(channel._state, null, time);\n  }\n}"],"names":["clearNodeFolder","enforceOptions","BroadcastChannel","name","options","ENFORCED_OPTIONS","fillOptionsWithDefaults","method","chooseMethod","_iL","_onML","_addEL","message","internal","_uMP","Set","_befC","_prepP","_prepareChannel","_pubkey","type","then","Promise","resolve","prototype","postMessage","msg","closed","Error","_post","postInternal","onmessage","fn","time","microSeconds","listenObj","_removeListenerObject","_addListenerObject","addEventListener","removeEventListener","obj","find","close","_this","awaitPrepare","all","Array","from","map","_state","isClosed","broadcastChannel","msgObj","data","sendPromise","add","channel","maybePromise","create","isPromise","s","_hasMessageListeners","length","push","_startListening","filter","o","_stopListening","listenerFn","forEach","onMessage"],"mappings":"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"}