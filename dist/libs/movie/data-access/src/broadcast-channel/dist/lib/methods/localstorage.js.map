{"version":3,"sources":["../../../../../../../../../libs/movie/data-access/node_modules/broadcast-channel/dist/lib/methods/localstorage.js"],"sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getLocalStorage = getLocalStorage;\nexports.storageKey = storageKey;\nexports.postMessage = postMessage;\nexports.addStorageEventListener = addStorageEventListener;\nexports.removeStorageEventListener = removeStorageEventListener;\nexports.create = create;\nexports.close = close;\nexports.onMessage = onMessage;\nexports.canBeUsed = canBeUsed;\nexports.averageResponseTime = averageResponseTime;\nexports[\"default\"] = exports.type = exports.microSeconds = void 0;\n\nvar _obliviousSet = require(\"oblivious-set\");\n\nvar _options = require(\"../options\");\n\nvar _util = require(\"../util\");\n\n/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\nvar microSeconds = _util.microSeconds;\nexports.microSeconds = microSeconds;\nvar KEY_PREFIX = 'pubkey.broadcastChannel-';\nvar type = 'localstorage';\n/**\n * copied from crosstab\n * @link https://github.com/tejacques/crosstab/blob/master/src/crosstab.js#L32\n */\n\nexports.type = type;\n\nfunction getLocalStorage() {\n  var localStorage;\n  if (typeof window === 'undefined') return null;\n\n  try {\n    localStorage = window.localStorage;\n    localStorage = window['ie8-eventlistener/storage'] || window.localStorage;\n  } catch (e) {// New versions of Firefox throw a Security exception\n    // if cookies are disabled. See\n    // https://bugzilla.mozilla.org/show_bug.cgi?id=1028153\n  }\n\n  return localStorage;\n}\n\nfunction storageKey(channelName) {\n  return KEY_PREFIX + channelName;\n}\n/**\n* writes the new message to the storage\n* and fires the storage-event so other readers can find it\n*/\n\n\nfunction postMessage(channelState, messageJson) {\n  return new Promise(function (res) {\n    (0, _util.sleep)().then(function () {\n      var key = storageKey(channelState.channelName);\n      var writeObj = {\n        token: (0, _util.randomToken)(),\n        time: new Date().getTime(),\n        data: messageJson,\n        uuid: channelState.uuid\n      };\n      var value = JSON.stringify(writeObj);\n      getLocalStorage().setItem(key, value);\n      /**\n       * StorageEvent does not fire the 'storage' event\n       * in the window that changes the state of the local storage.\n       * So we fire it manually\n       */\n\n      var ev = document.createEvent('Event');\n      ev.initEvent('storage', true, true);\n      ev.key = key;\n      ev.newValue = value;\n      window.dispatchEvent(ev);\n      res();\n    });\n  });\n}\n\nfunction addStorageEventListener(channelName, fn) {\n  var key = storageKey(channelName);\n\n  var listener = function listener(ev) {\n    if (ev.key === key) {\n      fn(JSON.parse(ev.newValue));\n    }\n  };\n\n  window.addEventListener('storage', listener);\n  return listener;\n}\n\nfunction removeStorageEventListener(listener) {\n  window.removeEventListener('storage', listener);\n}\n\nfunction create(channelName, options) {\n  options = (0, _options.fillOptionsWithDefaults)(options);\n\n  if (!canBeUsed()) {\n    throw new Error('BroadcastChannel: localstorage cannot be used');\n  }\n\n  var uuid = (0, _util.randomToken)();\n  /**\n   * eMIs\n   * contains all messages that have been emitted before\n   * @type {ObliviousSet}\n   */\n\n  var eMIs = new _obliviousSet.ObliviousSet(options.localstorage.removeTimeout);\n  var state = {\n    channelName: channelName,\n    uuid: uuid,\n    eMIs: eMIs // emittedMessagesIds\n\n  };\n  state.listener = addStorageEventListener(channelName, function (msgObj) {\n    if (!state.messagesCallback) return; // no listener\n\n    if (msgObj.uuid === uuid) return; // own message\n\n    if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n\n    if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n    eMIs.add(msgObj.token);\n    state.messagesCallback(msgObj.data);\n  });\n  return state;\n}\n\nfunction close(channelState) {\n  removeStorageEventListener(channelState.listener);\n}\n\nfunction onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n}\n\nfunction canBeUsed() {\n  if (_util.isNode) return false;\n  var ls = getLocalStorage();\n  if (!ls) return false;\n\n  try {\n    var key = '__broadcastchannel_check';\n    ls.setItem(key, 'works');\n    ls.removeItem(key);\n  } catch (e) {\n    // Safari 10 in private mode will not allow write access to local\n    // storage and fail with a QuotaExceededError. See\n    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API#Private_Browsing_Incognito_modes\n    return false;\n  }\n\n  return true;\n}\n\nfunction averageResponseTime() {\n  var defaultTime = 120;\n  var userAgent = navigator.userAgent.toLowerCase();\n\n  if (userAgent.includes('safari') && !userAgent.includes('chrome')) {\n    // safari is much slower so this time is higher\n    return defaultTime * 2;\n  }\n\n  return defaultTime;\n}\n\nvar _default = {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};\nexports[\"default\"] = _default;"],"names":["Object","defineProperty","exports","value","getLocalStorage","storageKey","postMessage","addStorageEventListener","removeStorageEventListener","create","close","onMessage","canBeUsed","averageResponseTime","type","microSeconds","_obliviousSet","require","_options","_util","KEY_PREFIX","localStorage","window","e","channelName","channelState","messageJson","Promise","res","sleep","then","key","writeObj","token","randomToken","time","Date","getTime","data","uuid","JSON","stringify","setItem","ev","document","createEvent","initEvent","newValue","dispatchEvent","fn","listener","parse","addEventListener","removeEventListener","options","fillOptionsWithDefaults","Error","eMIs","ObliviousSet","localstorage","removeTimeout","state","msgObj","messagesCallback","has","messagesCallbackTime","add","isNode","ls","removeItem","defaultTime","userAgent","navigator","toLowerCase","includes","_default"],"mappings":"AAAA,CAAY;AAEZA,MAAM,CAACC,cAAc,CAACC,OAAO,EAAE,CAAY,aAAE,CAAC;IAC5CC,KAAK,EAAE,IAAI;AACb,CAAC;AACDD,OAAO,CAACE,eAAe,GAAGA,eAAe;AACzCF,OAAO,CAACG,UAAU,GAAGA,UAAU;AAC/BH,OAAO,CAACI,WAAW,GAAGA,WAAW;AACjCJ,OAAO,CAACK,uBAAuB,GAAGA,uBAAuB;AACzDL,OAAO,CAACM,0BAA0B,GAAGA,0BAA0B;AAC/DN,OAAO,CAACO,MAAM,GAAGA,MAAM;AACvBP,OAAO,CAACQ,KAAK,GAAGA,KAAK;AACrBR,OAAO,CAACS,SAAS,GAAGA,SAAS;AAC7BT,OAAO,CAACU,SAAS,GAAGA,SAAS;AAC7BV,OAAO,CAACW,mBAAmB,GAAGA,mBAAmB;AACjDX,OAAO,CAAC,CAAS,YAAIA,OAAO,CAACY,IAAI,GAAGZ,OAAO,CAACa,YAAY,GAAG,IAAI,CAAC,CAAC;AAEjE,GAAG,CAACC,aAAa,GAAGC,OAAO,CAAC,CAAe;AAE3C,GAAG,CAACC,QAAQ,GAAGD,OAAO,CAAC,CAAY;AAEnC,GAAG,CAACE,KAAK,GAAGF,OAAO,CAAC,CAAS;AAE7B,EAMG,AANH;;;;;;CAMG,AANH,EAMG,CACH,GAAG,CAACF,YAAY,GAAGI,KAAK,CAACJ,YAAY;AACrCb,OAAO,CAACa,YAAY,GAAGA,YAAY;AACnC,GAAG,CAACK,UAAU,GAAG,CAA0B;AAC3C,GAAG,CAACN,IAAI,GAAG,CAAc;AACzB,EAGG,AAHH;;;CAGG,AAHH,EAGG,CAEHZ,OAAO,CAACY,IAAI,GAAGA,IAAI;SAEVV,eAAe,GAAG,CAAC;IAC1B,GAAG,CAACiB,YAAY;IAChB,EAAE,EAAE,MAAM,CAACC,MAAM,KAAK,CAAW,YAAE,MAAM,CAAC,IAAI;IAE9C,GAAG,CAAC,CAAC;QACHD,YAAY,GAAGC,MAAM,CAACD,YAAY;QAClCA,YAAY,GAAGC,MAAM,CAAC,CAA2B,+BAAKA,MAAM,CAACD,YAAY;IAC3E,CAAC,CAAC,KAAK,EAAEE,CAAC,EAAE,CAAC;IACX,EAA+B,AAA/B,6BAA+B;IAC/B,EAAuD,AAAvD,qDAAuD;IACzD,CAAC;IAED,MAAM,CAACF,YAAY;AACrB,CAAC;SAEQhB,UAAU,CAACmB,WAAW,EAAE,CAAC;IAChC,MAAM,CAACJ,UAAU,GAAGI,WAAW;AACjC,CAAC;AACD,EAGE,AAHF;;;AAGE,AAHF,EAGE,UAGOlB,WAAW,CAACmB,YAAY,EAAEC,WAAW,EAAE,CAAC;IAC/C,MAAM,CAAC,GAAG,CAACC,OAAO,CAAC,QAAQ,CAAEC,GAAG,EAAE,CAAC;SAChC,CAAC,EAAET,KAAK,CAACU,KAAK,IAAIC,IAAI,CAAC,QAAQ,GAAI,CAAC;YACnC,GAAG,CAACC,GAAG,GAAG1B,UAAU,CAACoB,YAAY,CAACD,WAAW;YAC7C,GAAG,CAACQ,QAAQ,GAAG,CAAC;gBACdC,KAAK,GAAG,CAAC,EAAEd,KAAK,CAACe,WAAW;gBAC5BC,IAAI,EAAE,GAAG,CAACC,IAAI,GAAGC,OAAO;gBACxBC,IAAI,EAAEZ,WAAW;gBACjBa,IAAI,EAAEd,YAAY,CAACc,IAAI;YACzB,CAAC;YACD,GAAG,CAACpC,KAAK,GAAGqC,IAAI,CAACC,SAAS,CAACT,QAAQ;YACnC5B,eAAe,GAAGsC,OAAO,CAACX,GAAG,EAAE5B,KAAK;YACpC,EAIG,AAJH;;;;OAIG,AAJH,EAIG,CAEH,GAAG,CAACwC,EAAE,GAAGC,QAAQ,CAACC,WAAW,CAAC,CAAO;YACrCF,EAAE,CAACG,SAAS,CAAC,CAAS,UAAE,IAAI,EAAE,IAAI;YAClCH,EAAE,CAACZ,GAAG,GAAGA,GAAG;YACZY,EAAE,CAACI,QAAQ,GAAG5C,KAAK;YACnBmB,MAAM,CAAC0B,aAAa,CAACL,EAAE;YACvBf,GAAG;QACL,CAAC;IACH,CAAC;AACH,CAAC;SAEQrB,uBAAuB,CAACiB,WAAW,EAAEyB,EAAE,EAAE,CAAC;IACjD,GAAG,CAAClB,GAAG,GAAG1B,UAAU,CAACmB,WAAW;IAEhC,GAAG,CAAC0B,QAAQ,GAAG,QAAQ,CAACA,QAAQ,CAACP,EAAE,EAAE,CAAC;QACpC,EAAE,EAAEA,EAAE,CAACZ,GAAG,KAAKA,GAAG,EAAE,CAAC;YACnBkB,EAAE,CAACT,IAAI,CAACW,KAAK,CAACR,EAAE,CAACI,QAAQ;QAC3B,CAAC;IACH,CAAC;IAEDzB,MAAM,CAAC8B,gBAAgB,CAAC,CAAS,UAAEF,QAAQ;IAC3C,MAAM,CAACA,QAAQ;AACjB,CAAC;SAEQ1C,0BAA0B,CAAC0C,QAAQ,EAAE,CAAC;IAC7C5B,MAAM,CAAC+B,mBAAmB,CAAC,CAAS,UAAEH,QAAQ;AAChD,CAAC;SAEQzC,MAAM,CAACe,WAAW,EAAE8B,OAAO,EAAE,CAAC;IACrCA,OAAO,IAAI,CAAC,EAAEpC,QAAQ,CAACqC,uBAAuB,EAAED,OAAO;IAEvD,EAAE,GAAG1C,SAAS,IAAI,CAAC;QACjB,KAAK,CAAC,GAAG,CAAC4C,KAAK,CAAC,CAA+C;IACjE,CAAC;IAED,GAAG,CAACjB,IAAI,IAAI,CAAC,EAAEpB,KAAK,CAACe,WAAW;IAChC,EAIG,AAJH;;;;GAIG,AAJH,EAIG,CAEH,GAAG,CAACuB,IAAI,GAAG,GAAG,CAACzC,aAAa,CAAC0C,YAAY,CAACJ,OAAO,CAACK,YAAY,CAACC,aAAa;IAC5E,GAAG,CAACC,KAAK,GAAG,CAAC;QACXrC,WAAW,EAAEA,WAAW;QACxBe,IAAI,EAAEA,IAAI;QACVkB,IAAI,EAAEA,IAAI,AAAC,CAAqB,AAArB,EAAqB,AAArB,mBAAqB;IAElC,CAAC;IACDI,KAAK,CAACX,QAAQ,GAAG3C,uBAAuB,CAACiB,WAAW,EAAE,QAAQ,CAAEsC,MAAM,EAAE,CAAC;QACvE,EAAE,GAAGD,KAAK,CAACE,gBAAgB,EAAE,MAAM,CAAE,CAAc,AAAd,EAAc,AAAd,YAAc;QAEnD,EAAE,EAAED,MAAM,CAACvB,IAAI,KAAKA,IAAI,EAAE,MAAM,CAAE,CAAc,AAAd,EAAc,AAAd,YAAc;QAEhD,EAAE,GAAGuB,MAAM,CAAC7B,KAAK,IAAIwB,IAAI,CAACO,GAAG,CAACF,MAAM,CAAC7B,KAAK,GAAG,MAAM,CAAE,CAAkB,AAAlB,EAAkB,AAAlB,gBAAkB;QAEvE,EAAE,EAAE6B,MAAM,CAACxB,IAAI,CAACH,IAAI,IAAI2B,MAAM,CAACxB,IAAI,CAACH,IAAI,GAAG0B,KAAK,CAACI,oBAAoB,EAAE,MAAM,CAAE,CAAU,AAAV,EAAU,AAAV,QAAU;QAEzFR,IAAI,CAACS,GAAG,CAACJ,MAAM,CAAC7B,KAAK;QACrB4B,KAAK,CAACE,gBAAgB,CAACD,MAAM,CAACxB,IAAI;IACpC,CAAC;IACD,MAAM,CAACuB,KAAK;AACd,CAAC;SAEQnD,KAAK,CAACe,YAAY,EAAE,CAAC;IAC5BjB,0BAA0B,CAACiB,YAAY,CAACyB,QAAQ;AAClD,CAAC;SAEQvC,SAAS,CAACc,YAAY,EAAEwB,EAAE,EAAEd,IAAI,EAAE,CAAC;IAC1CV,YAAY,CAACwC,oBAAoB,GAAG9B,IAAI;IACxCV,YAAY,CAACsC,gBAAgB,GAAGd,EAAE;AACpC,CAAC;SAEQrC,SAAS,GAAG,CAAC;IACpB,EAAE,EAAEO,KAAK,CAACgD,MAAM,EAAE,MAAM,CAAC,KAAK;IAC9B,GAAG,CAACC,EAAE,GAAGhE,eAAe;IACxB,EAAE,GAAGgE,EAAE,EAAE,MAAM,CAAC,KAAK;IAErB,GAAG,CAAC,CAAC;QACH,GAAG,CAACrC,GAAG,GAAG,CAA0B;QACpCqC,EAAE,CAAC1B,OAAO,CAACX,GAAG,EAAE,CAAO;QACvBqC,EAAE,CAACC,UAAU,CAACtC,GAAG;IACnB,CAAC,CAAC,KAAK,EAAER,CAAC,EAAE,CAAC;QACX,EAAiE,AAAjE,+DAAiE;QACjE,EAAkD,AAAlD,gDAAkD;QAClD,EAAoG,AAApG,kGAAoG;QACpG,MAAM,CAAC,KAAK;IACd,CAAC;IAED,MAAM,CAAC,IAAI;AACb,CAAC;SAEQV,mBAAmB,GAAG,CAAC;IAC9B,GAAG,CAACyD,WAAW,GAAG,GAAG;IACrB,GAAG,CAACC,SAAS,GAAGC,SAAS,CAACD,SAAS,CAACE,WAAW;IAE/C,EAAE,EAAEF,SAAS,CAACG,QAAQ,CAAC,CAAQ,aAAMH,SAAS,CAACG,QAAQ,CAAC,CAAQ,UAAG,CAAC;QAClE,EAA+C,AAA/C,6CAA+C;QAC/C,MAAM,CAACJ,WAAW,GAAG,CAAC;IACxB,CAAC;IAED,MAAM,CAACA,WAAW;AACpB,CAAC;AAED,GAAG,CAACK,QAAQ,GAAG,CAAC;IACdlE,MAAM,EAAEA,MAAM;IACdC,KAAK,EAAEA,KAAK;IACZC,SAAS,EAAEA,SAAS;IACpBL,WAAW,EAAEA,WAAW;IACxBM,SAAS,EAAEA,SAAS;IACpBE,IAAI,EAAEA,IAAI;IACVD,mBAAmB,EAAEA,mBAAmB;IACxCE,YAAY,EAAEA,YAAY;AAC5B,CAAC;AACDb,OAAO,CAAC,CAAS,YAAIyE,QAAQ"}